name: main_backend_ci_cd_pipeline
on:
  push:
    branches:
      - "main"
    paths:
      - "backend/**"
  workflow_dispatch:
env:
  SHH_USER_PASSWORD: ${{secrets.SHH_USER_PASSWORD}}
  DOCKER_HUB_USERNAME: ${{secrets.DOCKER_HUB_USERNAME}}
  DOCKER_HUB_PASSWORD: ${{secrets.DOCKER_HUB_PASSWORD}}

  DOCKER_IMAGE_TAG: ${{secrets.DOCKER_HUB_USERNAME}}/${{secrets.DOCKER_HUB_APP_IMAGE}}:backend-main

  DOCKER_NETWORK_NAME: quiz-grad-main-network
  DOCKER_VOLUME_NAME: data-main-qg

  DOCKER_DATABASE_CONTAINER_NAME: ${{secrets.MYSQL_DATABASE_MAIN}}
  DOCKER_BACKEND_CONTAINER_NAME: quiz-grad-backend-main

jobs:
  build-test-push-docker-image:
    name: Build, Test and Push Docker Image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.ref }}

      - name: Build Docker Image
        run: docker build -t $DOCKER_IMAGE_TAG --target=build ./backend

      - name: Run Prettier
        run: docker run $DOCKER_IMAGE_TAG sh -c 'npm run format:verify'

      - name: Run ESLint
        run: docker run $DOCKER_IMAGE_TAG sh -c 'npm run lint'

      # - name: Run Tests
      #   run: docker run $DOCKER_IMAGE_TAG sh -c 'npm run test'

      - name: Build Docker Image Production
        run: docker build -t $DOCKER_IMAGE_TAG ./backend

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{env.DOCKER_HUB_USERNAME}}
          password: ${{env.DOCKER_HUB_PASSWORD}}

      - name: Push to Dockerhub
        run: docker push ${{env.DOCKER_IMAGE_TAG}}

  build-database:
    name: Build Database Container
    runs-on: self-hosted
    needs: build-test-push-docker-image
    steps:
      - name: Network Creation
        run: echo ${{env.SHH_USER_PASSWORD}} | sudo -S docker network create ${{env.DOCKER_NETWORK_NAME}} || true

      - name: Stop Current Running Container
        run: echo ${{env.SHH_USER_PASSWORD}} | sudo -S docker stop ${{env.DOCKER_DATABASE_CONTAINER_NAME}} || true

      - name: Run Docker Container
        run: |
          echo ${{env.SHH_USER_PASSWORD}} | sudo -S docker run --rm -d \
            # Enviroments' values
            -e MYSQL_DATABASE=${{secrets.MYSQL_DATABASE_MAIN}} \
            -e MYSQL_USER=${{secrets.MYSQL_USER_MAIN}} \
            -e MYSQL_PASSWORD=${{secrets.MYSQL_PASSWORD_MAIN}} \
            -e MYSQL_ROOT_PASSWORD=${{secrets.MYSQL_ROOT_PASSWORD_MAIN}} \
            # Container's name
            --name ${{env.DOCKER_DATABASE_CONTAINER_NAME}} \
            # Volume's name
            -v ${{env.DOCKER_VOLUME_NAME}}:/var/lib/mysql \
            # Network's name
            --network ${{env.DOCKER_NETWORK_NAME}} \
            # Image's name
            mysql:8.3.0

  pull-backend-image-and-run-container:
    runs-on: self-hosted
    needs: build-database
    steps:
      - name: Network Creation
        run: echo ${{env.SHH_USER_PASSWORD}} | sudo -S docker network create ${{env.DOCKER_NETWORK_NAME}} || true

      - name: Stop Current Running Container
        run: echo ${{env.SHH_USER_PASSWORD}} | sudo -S docker stop ${{env.DOCKER_BACKEND_CONTAINER_NAME}} || true

      - name: Pull Docker Image
        run: echo ${{env.SHH_USER_PASSWORD}} | sudo -S docker pull ${{env.DOCKER_IMAGE_TAG}}

      - name: Run Docker Container
        run: |
          echo ${{env.SHH_USER_PASSWORD}} | sudo -S docker run --rm -d \
            # Ports
            -p ${{secrets.BACKEND_HOST_PORT_MAIN}}:${{secrets.BACKEND_CONTAINER_PORT_MAIN}} \
            # Enviroments' values
            -e BACKEND_CONTAINER_PORT=${{secrets.BACKEND_CONTAINER_PORT_MAIN}} \
            -e MYSQL_HOST=${{secrets.MYSQL_DATABASE_MAIN}} \
            -e MYSQL_PORT=${{secrets.MYSQL_CONTAINER_PORT_MAIN}} \
            -e MYSQL_DATABASE=${{secrets.MYSQL_DATABASE_MAIN}} \
            -e MYSQL_USER=${{secrets.MYSQL_USER_MAIN}} \
            -e MYSQL_PASSWORD=${{secrets.MYSQL_PASSWORD_MAIN}} \
            -e FRONTEND_HOST_DOMAIN=${{secrets.FRONTEND_HOST_DOMAIN_MAIN}} \
            -e COOKIE_SECRET=${{secrets.COOKIE_SECRET_MAIN}} \
            -e SENDGRID_API_KEY=${{secrets.SENDGRID_API_KEY_MAIN}} \
            -e SENDGRID_VERIFIED_EMAIL=${{secrets.SENDGRID_VERIFIED_EMAIL_MAIN}} \
            -e APP_NAME=${{secrets.APP_NAME}} \
            -e EMAIL_ADMINISTRATOR=${{secrets.EMAIL_ADMINISTRATOR}} \
            -e USER_DEMO=${{secrets.USER_DEMO}} \
            -e PASSWORD_DEMO=${{secrets.PASSWORD_DEMO}} \
            # Container's name
            --name ${{env.DOCKER_BACKEND_CONTAINER_NAME}} \
            # Network's name
            --network ${{env.DOCKER_NETWORK_NAME}} \
            ${{env.DOCKER_IMAGE_TAG}}
